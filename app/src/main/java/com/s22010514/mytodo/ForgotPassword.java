package com.s22010514.mytodo;

import androidx.appcompat.app.AppCompatActivity;
import android.content.Intent;
import android.os.Bundle;
import android.widget.Toast;
import com.google.android.material.button.MaterialButton;
import com.google.android.material.textfield.TextInputEditText;
import com.google.firebase.auth.FirebaseAuth;
import com.google.firebase.auth.ActionCodeSettings;
import android.app.AlertDialog;

public class ForgotPassword extends AppCompatActivity {

    private FirebaseAuth mAuth;
    private TextInputEditText emailInput;
    private MaterialButton resetPasswordBtn;
    private MaterialButton backToLoginBtn;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_forgot_password);

        // Initialize Firebase Auth
        mAuth = FirebaseAuth.getInstance();

        // Initialize views with null checks
        try {
            initializeViews();
            setupClickListeners();
        } catch (Exception e) {
            android.util.Log.e("ForgotPassword", "Error initializing views: " + e.getMessage());
            Toast.makeText(this, "Error loading page. Please restart the app.", Toast.LENGTH_LONG).show();
        }
    }

    private void initializeViews() {
        emailInput = findViewById(R.id.emailResetInput);
        resetPasswordBtn = findViewById(R.id.resetPasswordBtn);
        backToLoginBtn = findViewById(R.id.backToLoginBtn);

        // Verify views were found
        if (emailInput == null || resetPasswordBtn == null || backToLoginBtn == null) {
            android.util.Log.e("ForgotPassword", "One or more views not found in layout");
            throw new RuntimeException("Views not found in layout");
        }
    }

    private void setupClickListeners() {
        resetPasswordBtn.setOnClickListener(v -> sendPasswordResetEmail());
        backToLoginBtn.setOnClickListener(v -> goBackToLogin());
    }

    private void sendPasswordResetEmail() {
        if (emailInput == null || resetPasswordBtn == null) {
            Toast.makeText(this, "Error: Views not initialized", Toast.LENGTH_SHORT).show();
            return;
        }

        String email = emailInput.getText() != null ? emailInput.getText().toString().trim() : "";

        // Enhanced validation
        if (email.isEmpty()) {
            Toast.makeText(this, "Please enter your email address", Toast.LENGTH_SHORT).show();
            return;
        }

        if (!android.util.Patterns.EMAIL_ADDRESS.matcher(email).matches()) {
            Toast.makeText(this, "Please enter a valid email address", Toast.LENGTH_SHORT).show();
            return;
        }

        // Show loading state
        resetPasswordBtn.setEnabled(false);
        resetPasswordBtn.setText("Sending...");

        // Enhanced debugging
        android.util.Log.d("ForgotPassword", "=== EMAIL RESET DEBUG START ===");
        android.util.Log.d("ForgotPassword", "Email: " + email);
        android.util.Log.d("ForgotPassword", "Testing email domain: " + email.substring(email.indexOf("@")));

        // SKIP user registration check for now - proceed directly to email sending
        // This avoids the "email not registered" issue
        android.util.Log.d("ForgotPassword", "üöÄ Proceeding directly to email services (skipping registration check)");
        tryEmailJSFirst(email);
    }

    // Add a separate method for manual user check if needed
    private void checkUserRegistrationOptional(String email) {
        android.util.Log.d("ForgotPassword", "üîç Checking if user is registered...");

        mAuth.fetchSignInMethodsForEmail(email)
                .addOnCompleteListener(task -> {
                    if (task.isSuccessful()) {
                        boolean userExists = task.getResult().getSignInMethods().size() > 0;
                        android.util.Log.d("ForgotPassword", "User registration status: " + userExists);

                        if (!userExists) {
                            android.util.Log.w("ForgotPassword", "‚ö†Ô∏è Warning: Email might not be registered, but proceeding anyway");
                        }
                    } else {
                        android.util.Log.w("ForgotPassword", "‚ö†Ô∏è Could not verify user registration: " +
                            (task.getException() != null ? task.getException().getMessage() : "Unknown error"));
                    }
                });
    }

    private void tryEmailJSFirst(String email) {
        // Optional: Check user registration in background (doesn't block email sending)
        checkUserRegistrationOptional(email);

        // Try EmailJS service first (more reliable)
        EmailService emailService = new EmailService();
        String resetLink = "https://mytodoapp.page.link/reset?email=" + email;

        android.util.Log.d("ForgotPassword", "üöÄ Attempting EmailJS for: " + email);

        emailService.sendPasswordResetEmail(email, resetLink, new EmailService.EmailCallback() {
            @Override
            public void onSuccess() {
                android.util.Log.d("ForgotPassword", "‚úÖ EmailJS SUCCESS for: " + email);
                if (resetPasswordBtn != null) {
                    resetPasswordBtn.setEnabled(true);
                    resetPasswordBtn.setText("üîÑ Send Reset Link");
                }
                showEmailJSSuccessDialog(email);
            }

            @Override
            public void onFailure(String error) {
                android.util.Log.e("ForgotPassword", "‚ùå EmailJS FAILED for: " + email);
                android.util.Log.e("ForgotPassword", "‚ùå EmailJS Error details: " + error);

                // Always try Firebase as fallback regardless of EmailJS error
                android.util.Log.d("ForgotPassword", "üîÑ Trying Firebase Auth as fallback...");
                sendFirebasePasswordReset(email);
            }
        });
    }

    private void sendFirebasePasswordReset(String email) {
        android.util.Log.d("ForgotPassword", "üî• Attempting Firebase Auth for: " + email);

        // Use Firebase Auth directly - it will handle user existence check internally
        mAuth.sendPasswordResetEmail(email)
                .addOnCompleteListener(task -> {
                    // Reset button state
                    if (resetPasswordBtn != null) {
                        resetPasswordBtn.setEnabled(true);
                        resetPasswordBtn.setText("üîÑ Send Reset Link");
                    }

                    if (task.isSuccessful()) {
                        android.util.Log.d("ForgotPassword", "‚úÖ Firebase SUCCESS: Email sent to " + email);
                        showReliableSuccessDialog(email);
                    } else {
                        String errorMsg = task.getException() != null ?
                            task.getException().getMessage() : "Unknown error";
                        android.util.Log.e("ForgotPassword", "‚ùå Firebase ERROR: " + errorMsg);

                        // Check if it's a "user not found" error
                        if (errorMsg.contains("user-not-found") || errorMsg.contains("not found")) {
                            showUserNotFoundDialog(email);
                        } else {
                            showReliableErrorDialog(errorMsg, email);
                        }
                    }
                    android.util.Log.d("ForgotPassword", "=== EMAIL RESET DEBUG END ===");
                })
                .addOnFailureListener(e -> {
                    if (resetPasswordBtn != null) {
                        resetPasswordBtn.setEnabled(true);
                        resetPasswordBtn.setText("üîÑ Send Reset Link");
                    }
                    android.util.Log.e("ForgotPassword", "‚ùå Firebase FAILURE: " + e.getMessage());
                    showReliableErrorDialog("Email service error: " + e.getMessage(), email);
                });
    }

    private void showEmailJSSuccessDialog(String email) {
        new AlertDialog.Builder(this)
                .setTitle("üìß Reset Email Sent via EmailJS!")
                .setMessage("‚úÖ Professional email service confirmed: Email sent to\nüìß " + email +
                           "\n\nüîç CHECK YOUR EMAIL:\n" +
                           "‚Ä¢ Primary inbox (most likely location)\n" +
                           "‚Ä¢ EmailJS has better deliverability than Firebase\n" +
                           "‚Ä¢ Should arrive within 2-5 minutes\n\n" +
                           "‚è±Ô∏è TIMING:\n" +
                           "‚Ä¢ Usually arrives quickly (2-5 minutes)\n" +
                           "‚Ä¢ Professional email service\n" +
                           "‚Ä¢ Less likely to be marked as spam\n\n" +
                           "üí° TIPS:\n" +
                           "‚Ä¢ Look for sender: MyToDo Support\n" +
                           "‚Ä¢ Click the reset link in the email\n" +
                           "‚Ä¢ Link will redirect to password reset page")
                .setPositiveButton("üì± Open Email App", (dialog, which) -> openEmailApp())
                .setNeutralButton("üîÑ Send Again", (dialog, which) -> sendPasswordResetEmail())
                .setNegativeButton("‚úÖ Got It", null)
                .setCancelable(false)
                .show();
    }

    private void showReliableSuccessDialog(String email) {
        String emailProvider = email.substring(email.indexOf("@") + 1).toLowerCase();
        String specificInstructions = getEmailProviderInstructions(emailProvider);

        new AlertDialog.Builder(this)
                .setTitle("üìß Password Reset Email Sent!")
                .setMessage("‚úÖ Firebase confirmed: Email sent to\nüìß " + email +
                           "\n\nüîç CHECK THESE LOCATIONS:\n" +
                           specificInstructions +
                           "\n\n‚è±Ô∏è TIMING:\n" +
                           "‚Ä¢ Can take 2-10 minutes to arrive\n" +
                           "‚Ä¢ Sometimes up to 30 minutes\n" +
                           "‚Ä¢ Check every few minutes\n\n" +
                           "üö® IMPORTANT:\n" +
                           "‚Ä¢ 90% of missing emails are in SPAM folder\n" +
                           "‚Ä¢ Search for 'password reset' in your email\n" +
                           "‚Ä¢ Look for sender: noreply@*.firebaseapp.com")
                .setPositiveButton("üì± Open Email App", (dialog, which) -> openEmailApp())
                .setNeutralButton("üîç Search Email", (dialog, which) -> searchForEmail(email))
                .setNegativeButton("üîÑ Send Again", (dialog, which) -> sendPasswordResetEmail())
                .setCancelable(false)
                .show();
    }

    private String getEmailProviderInstructions(String domain) {
        switch (domain) {
            case "gmail.com":
                return "Gmail Users:\n" +
                       "‚Ä¢ Check 'Promotions' tab ‚≠ê\n" +
                       "‚Ä¢ Check 'Spam' folder ‚ö†Ô∏è\n" +
                       "‚Ä¢ Check 'All Mail' folder\n" +
                       "‚Ä¢ Use search: 'password reset'";
            case "yahoo.com":
            case "yahoo.co.uk":
                return "Yahoo Users:\n" +
                       "‚Ä¢ Check 'Spam' folder FIRST ‚ö†Ô∏è\n" +
                       "‚Ä¢ Check 'Bulk' folder\n" +
                       "‚Ä¢ Yahoo often blocks Firebase emails\n" +
                       "‚Ä¢ Try different email if persistent";
            case "outlook.com":
            case "hotmail.com":
            case "live.com":
                return "Microsoft Users:\n" +
                       "‚Ä¢ Check 'Junk Email' folder ‚ö†Ô∏è\n" +
                       "‚Ä¢ Check 'Deleted Items'\n" +
                       "‚Ä¢ Check 'Clutter' folder\n" +
                       "‚Ä¢ Microsoft often blocks automated emails";
            default:
                return "General Instructions:\n" +
                       "‚Ä¢ Check SPAM/Junk folder FIRST ‚ö†Ô∏è\n" +
                       "‚Ä¢ Check all email folders\n" +
                       "‚Ä¢ Search for 'password reset'\n" +
                       "‚Ä¢ Contact your email provider if missing";
        }
    }

    private void showReliableErrorDialog(String errorMessage, String email) {
        String solution = getErrorSolution(errorMessage);

        new AlertDialog.Builder(this)
                .setTitle("‚ùå Email Delivery Problem")
                .setMessage("Failed to send reset email to:\nüìß " + email +
                           "\n\nüîç Error Details:\n" + errorMessage +
                           "\n\n" + solution)
                .setPositiveButton("üîÑ Try Again", (dialog, which) -> sendPasswordResetEmail())
                .setNeutralButton("‚úèÔ∏è Try Different Email", (dialog, which) -> {
                    emailInput.setText("");
                    emailInput.requestFocus();
                })
                .setNegativeButton("üè† Back to Login", (dialog, which) -> goBackToLogin())
                .show();
    }

    private String getErrorSolution(String error) {
        if (error.contains("user-not-found") || error.contains("not found")) {
            return "üí° SOLUTION:\n" +
                   "‚Ä¢ This email is not registered\n" +
                   "‚Ä¢ Double-check spelling\n" +
                   "‚Ä¢ Try a different email\n" +
                   "‚Ä¢ Sign up for new account";
        } else if (error.contains("too-many-requests")) {
            return "üí° SOLUTION:\n" +
                   "‚Ä¢ Wait 15-30 minutes\n" +
                   "‚Ä¢ Check if email already arrived\n" +
                   "‚Ä¢ Try from different device";
        } else {
            return "üí° SOLUTIONS:\n" +
                   "‚Ä¢ Check internet connection\n" +
                   "‚Ä¢ Try again in 5 minutes\n" +
                   "‚Ä¢ Use different email provider\n" +
                   "‚Ä¢ Contact support if persistent";
        }
    }

    private void openEmailApp() {
        try {
            // Create intent with proper flags for better back navigation
            Intent emailIntent = new Intent(Intent.ACTION_MAIN);
            emailIntent.addCategory(Intent.CATEGORY_APP_EMAIL);
            emailIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);

            // Try to start email app with chooser
            if (emailIntent.resolveActivity(getPackageManager()) != null) {
                startActivity(Intent.createChooser(emailIntent, "Choose Email App"));
            } else {
                // Fallback: Try specific Gmail intent
                openGmailSpecifically();
            }
        } catch (Exception e) {
            android.util.Log.e("ForgotPassword", "Failed to open email app: " + e.getMessage());
            openGmailSpecifically();
        }
    }

    private void openGmailSpecifically() {
        try {
            // Try Gmail-specific intent first
            Intent gmailIntent = getPackageManager().getLaunchIntentForPackage("com.google.android.gm");
            if (gmailIntent != null) {
                gmailIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
                startActivity(gmailIntent);

                // Show helpful message
                Toast.makeText(this, "üìß Opening Gmail - Check your Spam folder!\nüëà Use Android back button to return to app",
                    Toast.LENGTH_LONG).show();
            } else {
                // Gmail not installed, try web Gmail
                openWebGmail();
            }
        } catch (Exception e) {
            android.util.Log.e("ForgotPassword", "Failed to open Gmail: " + e.getMessage());
            openWebGmail();
        }
    }

    private void openWebGmail() {
        try {
            // Open Gmail in web browser as last resort
            Intent webIntent = new Intent(Intent.ACTION_VIEW);
            webIntent.setData(android.net.Uri.parse("https://mail.google.com"));
            webIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
            startActivity(webIntent);

            Toast.makeText(this, "üìß Opening Gmail in browser - Check your Spam folder!", Toast.LENGTH_LONG).show();
        } catch (Exception e) {
            // Final fallback
            Toast.makeText(this, "üìß Please manually open your email app and check Spam folder",
                Toast.LENGTH_LONG).show();
        }
    }

    // Enhanced search method with better navigation
    private void searchForEmail(String email) {
        try {
            // Show instruction dialog first
            new AlertDialog.Builder(this)
                .setTitle("üîç How to Search for Reset Email")
                .setMessage("To find your password reset email:\n\n" +
                           "1Ô∏è‚É£ Open your email app\n" +
                           "2Ô∏è‚É£ Check SPAM folder first\n" +
                           "3Ô∏è‚É£ Search for: 'password reset'\n" +
                           "4Ô∏è‚É£ Look for sender: MyToDo Support\n\n" +
                           "üí° Use Android back button (‚óÄ) to return to this app")
                .setPositiveButton("üì± Open Email App", (dialog, which) -> {
                    openEmailApp();
                })
                .setNegativeButton("‚úÖ Got It", null)
                .show();
        } catch (Exception e) {
            Toast.makeText(this, "Please search 'password reset' in your email app", Toast.LENGTH_LONG).show();
        }
    }

    // Override back button handling to ensure proper navigation
    @Override
    public void onBackPressed() {
        // Show confirmation dialog before going back
        new AlertDialog.Builder(this)
            .setTitle("üîô Go Back?")
            .setMessage("Do you want to go back to the login page?")
            .setPositiveButton("Yes", (dialog, which) -> {
                super.onBackPressed();
            })
            .setNegativeButton("Stay Here", null)
            .show();
    }

    private void goBackToLogin() {
        Intent intent = new Intent(ForgotPassword.this, LoginPage.class);
        startActivity(intent);
        finish();
    }

    private void showUserNotFoundDialog(String email) {
        new AlertDialog.Builder(this)
                .setTitle("‚ùå Email Not Registered")
                .setMessage("The email address is not registered:\nüìß " + email +
                           "\n\nüí° SOLUTIONS:\n" +
                           "‚Ä¢ Double-check the email spelling\n" +
                           "‚Ä¢ Try a different email address\n" +
                           "‚Ä¢ Sign up for a new account\n" +
                           "‚Ä¢ Contact support if you believe this is an error")
                .setPositiveButton("‚úèÔ∏è Try Different Email", (dialog, which) -> {
                    emailInput.setText("");
                    emailInput.requestFocus();
                })
                .setNeutralButton("üìù Sign Up", (dialog, which) -> {
                    Intent intent = new Intent(ForgotPassword.this, SignupPage.class);
                    startActivity(intent);
                })
                .setNegativeButton("üè† Back to Login", (dialog, which) -> goBackToLogin())
                .show();
    }

    private void showEmailJSConfigError(String email, String error) {
        new AlertDialog.Builder(this)
                .setTitle("‚öôÔ∏è EmailJS Configuration Issue")
                .setMessage("There's an issue with the EmailJS configuration:\n\n" +
                           "üìß Email: " + email + "\n\n" +
                           "üîç Error: " + error + "\n\n" +
                           "üí° SOLUTIONS:\n" +
                           "‚Ä¢ EmailJS service might need configuration\n" +
                           "‚Ä¢ Template variables might not match\n" +
                           "‚Ä¢ Service limits might be reached\n" +
                           "‚Ä¢ Trying Firebase Auth as backup...")
                .setPositiveButton("üîÑ Try Firebase", (dialog, which) -> {
                    sendFirebasePasswordReset(email);
                })
                .setNeutralButton("‚úèÔ∏è Try Different Email", (dialog, which) -> {
                    emailInput.setText("");
                    emailInput.requestFocus();
                })
                .setNegativeButton("üè† Back to Login", (dialog, which) -> goBackToLogin())
                .show();
    }

}